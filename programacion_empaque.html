<!DOCTYPE html>
<html style="height: auto;">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>AdminLTE 3 | Hidrotérmico</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="resorce/plugins/fontawesome-free/css/all.min.css">
    <link rel="stylesheet" href="resorce/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css" rel="stylesheet">
</head>

<body class="sidebar-mini sidebar-collapse">

    <div class="wrapper">

        <nav class="main-header navbar navbar-expand navbar-white navbar-light"></nav>

        <aside class="main-sidebar sidebar-dark-primary elevation-4">
            <a class='brand-link' href='/resorce/index3'>
                <img src="resorce/dist/img/AdminLTELogo.png" class="brand-image img-circle elevation-3"
                    style="opacity: .8">
                <span class="brand-text font-weight-light">AdminLTE 3</span>
            </a>

            <div class="sidebar">
                <div class="user-panel mt-3 pb-3 mb-3 d-flex">
                    <div class="image">
                        <img src="resorce/dist/img/user2-160x160.jpg" class="img-circle elevation-2">
                    </div>
                    <div class="info">
                        <a href="#" class="d-block">Alexander Pierce</a>
                    </div>
                </div>

                <nav class="mt-2">
                    <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview">
                        <li class="nav-item">
                            <a class='nav-link' href='/'><i class="nav-icon far fa-circle text-warning"></i>
                                <p>Abastecimiento</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class='nav-link' href='hidro.html'><i class="nav-icon far fa-circle text-info"></i>
                                <p>Hidrotérmico</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="programacion_empaque.html" class="nav-link">
                                <i class="nav-icon far fa-circle text-info"></i>
                                <p>Programación Empaque</p>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </aside>

        <div class="content-wrapper">
            <section class="content pt-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        Registro de Despachos
                    </div>

                    <div class="card-body">

                        <div class="mb-3">
                            <button class="btn btn-success" data-toggle="modal" data-target="#modalRegistro">
                                + Nuevo Registro
                            </button>
                        </div>

                        <div class="table-responsive">
                            <table id="tablaDespachos" class="table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th>EXPORTADOR</th>
                                        <th>FECHA DESPACHO</th>
                                        <th>DESTINO</th>
                                        <th>LINEA</th>
                                        <th>ETD</th>
                                        <th>ETA</th>
                                        <th>SEMANA</th>
                                        <th>CAJA</th>
                                        <th>AGENTE</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>

                    </div>
                </div>

                <!-- MODAL -->
                <div class="modal fade" id="modalRegistro">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">

                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title">Registrar Despacho</h5>
                                <button type="button" class="close text-white" data-dismiss="modal">
                                    <span>&times;</span>
                                </button>
                            </div>

                            <div class="modal-body">

                                <!-- TABS -->
                                <ul class="nav nav-tabs" id="tabsRegistro" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" data-toggle="tab" href="#datos">Datos Generales</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-toggle="tab" href="#ficha">Ficha Técnica</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-toggle="tab" href="#calibresTab">Calibres</a>
                                    </li>
                                </ul>

                                <div class="tab-content pt-3">

                                    <!-- ================= DATOS GENERALES ================= -->
                                    <div class="tab-pane fade show active" id="datos">

                                        <div class="row">

                                            <div class="col-md-4">
                                                <label>Exportador</label>
                                                <input type="text" id="exportador" class="form-control">
                                            </div>

                                            <div class="col-md-4">
                                                <label>Fecha Despacho</label>
                                                <input type="date" id="fecha_despacho" class="form-control">
                                            </div>

                                            <div class="col-md-4">
                                                <label>Destino</label>
                                                <input type="text" id="destino" class="form-control">
                                            </div>

                                            <div class="col-md-4">
                                                <label>Línea</label>
                                                <input type="text" id="linea" class="form-control">
                                            </div>

                                            <div class="col-md-4">
                                                <label>ETD</label>
                                                <input type="date" id="etd" class="form-control">
                                            </div>

                                            <div class="col-md-4">
                                                <label>ETA</label>
                                                <input type="date" id="eta" class="form-control">
                                            </div>

                                            <div class="col-md-4">
                                                <label>Semana</label>
                                                <input type="text" id="semana" class="form-control">
                                            </div>

                                            <div class="col-md-4">
                                                <label>Caja</label>
                                                <input type="text" id="caja" class="form-control">
                                            </div>

                                            <div class="col-md-4">
                                                <label>Agente</label>
                                                <input type="text" id="agente" class="form-control">
                                            </div>

                                        </div>
                                    </div>

                                    <!-- ================= FICHA TECNICA ================= -->
                                    <div class="tab-pane fade" id="ficha">

                                        <div class="card card-success">
                                            <div class="card-header">
                                                <h3 class="card-title">Características Organolépticas</h3>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">

                                                    <div class="col-md-4">
                                                        <label>Color</label>
                                                        <input type="text" id="color" class="form-control">
                                                    </div>

                                                    <div class="col-md-2">
                                                        <label>Brix (%)</label>
                                                        <input type="text" id="brix" class="form-control">
                                                    </div>

                                                    <div class="col-md-3">
                                                        <label>Firmeza (kgf)</label>
                                                        <input type="text" id="firmeza" class="form-control">
                                                    </div>

                                                    <div class="col-md-2">
                                                        <label>MS (%)</label>
                                                        <input type="text" id="ms" class="form-control">
                                                    </div>

                                                </div>
                                            </div>
                                        </div>

                                        <div class="card card-success">
                                            <div class="card-header">
                                                <h3 class="card-title">Características de Empaque</h3>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">

                                                    <div class="col-md-4">
                                                        <label>Presentación</label>
                                                        <input type="text" id="presentacion" class="form-control">
                                                    </div>

                                                    <div class="col-md-3">
                                                        <label>Peso Neto (kg)</label>
                                                        <input type="text" id="peso_neto" class="form-control">
                                                    </div>

                                                    <div class="col-md-4">
                                                        <label>Marca Caja</label>
                                                        <input type="text" id="marca_caja" class="form-control">
                                                    </div>

                                                    <div class="col-md-3">
                                                        <label>Humedad (%)</label>
                                                        <input type="text" id="humedad" class="form-control">
                                                    </div>

                                                    <div class="col-md-3">
                                                        <label>Gramaje (g)</label>
                                                        <input type="text" id="gramaje" class="form-control">
                                                    </div>

                                                </div>
                                            </div>
                                        </div>

                                        <div class="card card-success">
                                            <div class="card-header">
                                                <h3 class="card-title">Paletizado</h3>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">

                                                    <div class="col-md-4">
                                                        <label>Medida Pallet</label>
                                                        <input type="text" id="medida_pallet" class="form-control">
                                                    </div>

                                                    <div class="col-md-3">
                                                        <label>Cajas por Nivel</label>
                                                        <input type="number" id="cajas_nivel" class="form-control">
                                                    </div>

                                                    <div class="col-md-3">
                                                        <label>Niveles</label>
                                                        <input type="number" id="niveles" class="form-control">
                                                    </div>

                                                    <div class="col-md-3">
                                                        <label>Zunchos</label>
                                                        <input type="number" id="zunchos" class="form-control">
                                                    </div>

                                                    <div class="col-md-3">
                                                        <label>Esquineros</label>
                                                        <input type="text" id="esquineros" class="form-control">
                                                    </div>

                                                </div>
                                            </div>
                                        </div>

                                    </div>

                                    <!-- ================= CALIBRES ================= -->
                                    <div class="tab-pane fade" id="calibresTab">

                                        <!-- MOVIDO AQUI -->
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label>Cantidad Total de Pallets</label>
                                                <input type="number" id="totalPallets" class="form-control" min="1"
                                                    oninput="recalcularTodo()">
                                            </div>
                                        </div>

                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="text-success mb-0">Calibres</h6>
                                            <button type="button" class="btn btn-sm btn-success" onclick="agregarCalibre()">
                                                + Agregar Calibre
                                            </button>
                                        </div>

                                        <div id="contenedorCalibres"></div>

                                        <div class="row mt-2">
                                            <div class="col-md-12 text-right">
                                                <strong>
                                                    Pallets usados: <span id="totalPalletsUsados">0</span>
                                                    |
                                                    Total: <span id="totalPorcentaje">0</span>%
                                                </strong>
                                                <span id="mensajeTotal" class="ml-2 font-weight-bold"></span>
                                            </div>
                                        </div>

                                    </div>

                                </div>

                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                                <button type="button" class="btn btn-success"
                                    onclick="agregarRegistro()">Guardar</button>
                            </div>

                        </div>
                    </div>
                </div>

            </section>
        </div>

        <footer class="main-footer">
            <div class="float-right d-none d-sm-block">
                <b>Version</b> 3.0.0
            </div>
            <strong>Copyright © 2026<a href="#">Koricancha</a>.</strong>
        </footer>

    </div>

    <script src="resorce/plugins/jquery/jquery.min.js"></script>
    <script src="resorce/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="resorce/dist/js/adminlte.min.js"></script>

    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        let tabla;

        $(document).ready(function () {
            tabla = $('#tablaDespachos').DataTable({
                language: {
                    url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
                }
            });
        });

        function agregarRegistro() {

            const campos = [
                '#exportador',
                '#fecha_despacho',
                '#destino',
                '#linea',
                '#etd',
                '#eta',
                '#semana',
                '#caja',
                '#agente'
            ];

            for (let campo of campos) {
                if ($(campo).val().trim() === "") {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Campo obligatorio',
                        text: 'Todos los campos deben estar completos',
                        confirmButtonColor: '#3085d6'
                    });
                    return;
                }
            }

            tabla.row.add([
                $('#exportador').val(),
                $('#fecha_despacho').val(),
                $('#destino').val(),
                $('#linea').val(),
                $('#etd').val(),
                $('#eta').val(),
                $('#semana').val(),
                $('#caja').val(),
                $('#agente').val()
            ]).draw();

            Swal.fire({
                icon: 'success',
                title: 'Registro guardado',
                text: 'El despacho fue registrado correctamente',
                timer: 1800,
                showConfirmButton: false
            });

            $('#modalRegistro input').val('');
            $('#modalRegistro').modal('hide');
        }

let contadorCalibres = 0;

    function agregarCalibre() {

        contadorCalibres++;

        const contenedor = document.getElementById("contenedorCalibres");

        const fila = document.createElement("div");
        fila.className = "row mb-2";
        fila.id = "filaCalibre_" + contadorCalibres;

        fila.innerHTML = `
            <div class="col-md-4">
                <label>Calibre</label>
                <input type="number" class="form-control" name="calibre[]">
            </div>

            <div class="col-md-4">
                <label>Pallets</label>
                <input type="number" class="form-control pallets-input"
                    name="pallets[]" min="0"
                    oninput="recalcularTodo()">
            </div>

            <div class="col-md-3">
                <label>Porcentaje (%)</label>
                <input type="number" class="form-control porcentaje-input"
                    name="porcentaje[]" readonly>
            </div>

            <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-danger btn-block"
                        onclick="eliminarCalibre(${contadorCalibres})">
                    X
                </button>
            </div>
        `;

        contenedor.appendChild(fila);
    }

    function eliminarCalibre(id) {
        const fila = document.getElementById("filaCalibre_" + id);
        fila.remove();
        recalcularTodo();
    }

    function recalcularTodo() {

        const totalPallets = parseFloat(document.getElementById("totalPallets").value) || 0;

        let sumaPallets = 0;

        const palletsInputs = document.querySelectorAll(".pallets-input");
        const porcentajeInputs = document.querySelectorAll(".porcentaje-input");

        palletsInputs.forEach(input => {
            sumaPallets += parseFloat(input.value) || 0;
        });

        // VALIDACIÓN REAL POR PALLETS (más importante que porcentaje)
        if (totalPallets > 0 && sumaPallets > totalPallets) {
            Swal.fire({
                icon: 'warning',
                title: '¡Advertencia!',
                text: 'No puede exceder el total de pallets del contenedor',
                confirmButtonColor: '#3085d6'
            });
            return;
        }

        //  Calcular porcentajes
        palletsInputs.forEach((input, index) => {

            const pallets = parseFloat(input.value) || 0;

            if (totalPallets > 0) {
                let porcentajeReal = (pallets / totalPallets) * 100;
                porcentajeInputs[index].value = porcentajeReal.toFixed(2);
            } else {
                porcentajeInputs[index].value = 0;
            }

        });

        // Calcular total porcentaje REAL (sin redondeo acumulado)
        let totalPorcentajeReal = 0;

        palletsInputs.forEach(input => {
            const pallets = parseFloat(input.value) || 0;
            if (totalPallets > 0) {
                totalPorcentajeReal += (pallets / totalPallets) * 100;
            }
        });

        document.getElementById("totalPalletsUsados").innerText = sumaPallets;
        document.getElementById("totalPorcentaje").innerText = totalPorcentajeReal.toFixed(2);

        const mensaje = document.getElementById("mensajeTotal");

        // VALIDACIÓN CORRECTA BASADA EN PALLETS (NO EN DECIMALES)
        if (totalPallets > 0 && sumaPallets === totalPallets) {
            mensaje.innerText = "Completo";
            mensaje.style.color = "green";
        } 
        else if (totalPallets > 0 && sumaPallets > totalPallets) {
            mensaje.innerText = "Excede pallets";
            mensaje.style.color = "red";
        } 
        else {
            let faltan = totalPallets - sumaPallets;
            mensaje.innerText = "Faltan " + faltan + " pallets";
            mensaje.style.color = "orange";
        }
    }
</script>

</body>

</html>